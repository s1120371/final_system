<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æ¡ˆä»¶é€šå ±åœ°åœ–</title>
<style>
  body {
    margin: 0;
    font-family: Arial;
  }
  header {
    padding: 10px 20px;
    border-bottom: 1px solid #ccc;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #map {
    width: 100%;
    height: calc(100vh - 60px);
  }
</style>
</head>
<body>

<header>
  <h2>æ¡ˆä»¶é€šå ±åœ°åœ–</h2>
  <button onclick="history.back()">è¿”å›</button>
</header>

<div id="map"></div>

<!-- ğŸ” ç™»å…¥å®ˆé–€ -->
<script type="module" src="auth-guard.js"></script>

<!-- ================== Firebaseï¼šåªè² è²¬ã€ŒæŠ“è³‡æ–™ã€ ================== -->
<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs
} from
  "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* Firebase è¨­å®šï¼ˆä¸€å®šè¦å’Œå…¶ä»–é ä¸€è‡´ï¼‰ */
const firebaseConfig = {
  apiKey: "AIzaSyDQziEhhw0dPu_io9sfWT-a3sADgIKFSd4",
  authDomain: "system-b4d2d.firebaseapp.com",
  projectId: "system-b4d2d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* å…¨åŸŸè³‡æ–™å®¹å™¨ */
window.__reports = [];
window.__reportsReady = false;

/* å–å¾—æ‰€æœ‰é€šå ± */
const snap = await getDocs(collection(db, "reports"));

snap.forEach(docSnap => {
  const data = docSnap.data();
  window.__reports.push({
    id: docSnap.id,
    ...data
  });
});

/* â­ é—œéµï¼šé€šçŸ¥åœ°åœ–ã€Œè³‡æ–™å·²å®Œæˆã€ */
window.__reportsReady = true;
</script>

<!-- ================== Google Mapsï¼ˆé moduleï¼‰ ================== -->
<script>
  let map;

  /* Google Maps callback */
  function initMap() {
    // ç­‰ Firestore è³‡æ–™æº–å‚™å¥½
    const wait = setInterval(() => {
      if (window.__reportsReady) {
        clearInterval(wait);
        drawMap();
      }
    }, 100);
  }

  function drawMap() {
    // è‹¥æœ‰è³‡æ–™ï¼Œåœ°åœ–ä¸­å¿ƒç”¨ç¬¬ä¸€ç­†æ¡ˆä»¶
    const first = window.__reports.find(
      r => r.latitude != null && r.longitude != null
    );

    const center = first
      ? { lat: Number(first.latitude), lng: Number(first.longitude) }
      : { lat: 25.0478, lng: 121.5170 }; // fallback å°åŒ—

    map = new google.maps.Map(document.getElementById("map"), {
      center,
      zoom: 14
    });

    window.__reports.forEach(r => {
      if (r.latitude == null || r.longitude == null) return;

      const marker = new google.maps.Marker({
        position: {
          lat: Number(r.latitude),
          lng: Number(r.longitude)
        },
        map,
        title: r.title,
        icon: r.severity === "urgent"
          ? "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
          : "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
      });

      const info = new google.maps.InfoWindow({
        content: `
          <div style="max-width:220px">
            <strong>${r.title}</strong><br>
            åš´é‡ç¨‹åº¦ï¼š${r.severity === "urgent" ? "ç·Šæ€¥" : "ä¸€èˆ¬"}<br>
            ç‹€æ…‹ï¼š${statusText(r.status)}<br>
            <a href="report-detail.html?id=${r.id}">
              æŸ¥çœ‹è©³æƒ…
            </a>
          </div>
        `
      });

      marker.addListener("click", () => {
        info.open(map, marker);
      });
    });
  }

  function statusText(status) {
    switch (status) {
      case "submitted": return "å·²é€å‡º";
      case "processing": return "è™•ç†ä¸­";
      case "completed": return "å·²å®Œæˆ";
      default: return status;
    }
  }
</script>

<!-- ğŸ”‘ Google Maps APIï¼ˆè«‹æ›æˆä½ è‡ªå·±çš„ Keyï¼‰ -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDWncU5_3lao2CkDNUWf9llEMDywLUBmTs&callback=initMap"
  async
  defer>
</script>

</body>
</html>