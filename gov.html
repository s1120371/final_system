<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æ”¿åºœäººå“¡å¾Œå°ï½œæ¡ˆä»¶ç®¡ç†</title>

<style>
:root{
  --primary:#3F72AF;
  --bg:#f8f9fa;
  --card:#fff;
  --border:#dee2e6;
  --text:#343a40;
}
body{
  font-family:'Segoe UI',sans-serif;
  max-width:1100px;
  margin:30px auto;
  padding:0 20px;
  background:var(--bg);
  color:var(--text);
}
header{
  display:flex;
  justify-content:space-between;
  border-bottom:3px solid var(--primary);
  padding-bottom:10px;
}
h2{margin:0;color:var(--primary)}
button{
  padding:10px 18px;
  border:1px solid var(--border);
  background:#e9ecef;
  border-radius:5px;
  cursor:pointer;
}
button:hover{background:var(--primary);color:#fff}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:8px;
  padding:25px;
  margin-top:25px;
}

#map{height:300px;border-radius:6px;border:1px solid var(--border)}

.map-legend{
  display:flex;
  justify-content:center;
  gap:18px;
  margin-top:10px;
  flex-wrap:wrap;
}
.legend-item{
  display:flex;
  align-items:center;
  gap:6px;
  cursor:pointer;
  opacity:.5;
  padding:4px 8px;
  border-radius:4px;
}
.legend-item.active{
  opacity:1;
  font-weight:bold;
  background:#e9f0ff;
  color:var(--primary);
}
.legend-item img{width:18px}

select{padding:8px;border-radius:5px}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  border:1px solid var(--border);
  padding:10px;
  text-align:center;
}
th{background:#f5f8fc;color:var(--primary)}
.urgent{color:#e74c3c;font-weight:bold}
</style>
</head>

<body>

<header>
  <h2>æ”¿åºœæ¡ˆä»¶ç®¡ç†å¾Œå°</h2>
  <button id="logoutBtn">ç™»å‡º</button>
</header>

<div class="card">
  <p><strong>ğŸ‘¤ ç™»å…¥è€…ï¼š</strong><span id="userEmail">è¼‰å…¥ä¸­...</span></p>
  <p><strong>ğŸŒŸ èº«åˆ†ï¼š</strong>æ”¿åºœäººå“¡</p>
</div>

<!-- ===== åœ°åœ– ===== -->
<div class="card">
  <h3>æ¡ˆä»¶åœ°åœ–</h3>
  <div id="map"></div>
<div id="statusSummary" style="
  text-align:center;
  margin-top:10px;
  font-size:14px;
  color:#343a40;
  font-weight:bold;
">
  è¼‰å…¥ä¸­...
</div>
  <div class="map-legend">
    <span class="legend-item active" data-status="all">ğŸ“ å…¨éƒ¨</span>
    <span class="legend-item" data-status="submitted">
      <img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png"> å°šæœªè™•ç†
    </span>
    <span class="legend-item" data-status="assigned">
  <img src="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"> å·²æŒ‡æ´¾
</span>

    <span class="legend-item" data-status="completed">
      <img src="http://maps.google.com/mapfiles/ms/icons/green-dot.png"> å·²å®Œæˆ
    </span>
  </div>
</div>

<!-- ===== æ¸…å–® ===== -->
<div class="card">
  <h3>æ¡ˆä»¶æ¸…å–®</h3>

  <label>ç¯©é¸ç‹€æ…‹ï¼š</label>
  <select id="statusFilter">
    <option value="all">å…¨éƒ¨</option>
    <option value="submitted">å°šæœªè™•ç†</option>
    <option value="assigned">å·²æŒ‡æ´¾</option>
    <option value="completed">å·²å®Œæˆ</option>
  </select>

  <table>
    <thead>
      <tr>
        <th>æ¨™é¡Œ</th>
        <th>åš´é‡ç¨‹åº¦</th>
        <th>ç‹€æ…‹</th>
        <th>å»ºç«‹æ™‚é–“</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="reportTable"></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore,collection,getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* Firebase */
const app=initializeApp({
  apiKey:"AIzaSyDQziEhhw0dPu_io9sfWT-a3sADgIKFSd4",
  authDomain:"system-b4d2d.firebaseapp.com",
  projectId:"system-b4d2d"
});
const auth=getAuth(app);
const db=getFirestore(app);
function sortSubmittedBySeverity(reports){
  const order = { urgent: 0, normal: 1 };

  return [...reports].sort((a, b) => {
    return (order[a.severity] ?? 99) - (order[b.severity] ?? 99);
  });
}
/* DOM */
const tableBody=document.getElementById("reportTable");
const statusFilter=document.getElementById("statusFilter");
const legends=document.querySelectorAll(".legend-item");

let allReports=[],map,markers=[];

/* Auth */
onAuthStateChanged(auth,async user=>{
  if(!user) return;
  userEmail.innerText=user.email;
  const snap=await getDocs(collection(db,"reports"));
  allReports=snap.docs.map(d=>({id:d.id,...d.data()}));
  updateStatusSummary(allReports);
  initMap();
  syncUI("all");
});

logoutBtn.onclick=async()=>{await signOut(auth);location.href="auth.html"};
function normalizeStatus(status){
  return status === "processing" ? "assigned" : status;
}

function updateStatusSummary(reports){
  const count = {
    submitted: 0,
    assigned: 0,
    processing: 0,
    completed: 0
  };

  reports.forEach(r=>{
    if(count[r.status] !== undefined){
      count[r.status]++;
    }
  });

  const total =
    count.submitted +
    count.assigned +
    count.processing +
    count.completed;

  document.getElementById("statusSummary").innerText =
    `å°šæœªè™•ç†ï¼š${count.submitted} ï½œ ` +
    `å·²æŒ‡æ´¾ï¼š${count.assigned} ï½œ ` +
    `è™•ç†ä¸­ï¼š${count.processing} ï½œ ` +
    `å·²å®Œæˆï¼š${count.completed} ï½œ ` +
    `å…± ${total} ä»¶`;
}
/* Map */
function initMap(){
  const valid = allReports.filter(r=>r.latitude && r.longitude);

  map = new google.maps.Map(document.getElementById("map"),{
    center: valid.length
      ? { lat:+valid[0].latitude, lng:+valid[0].longitude }
      : { lat:25.0478, lng:121.5170 },
    zoom:12
  });

  markers = valid.map(r=>{
    const s = normalizeStatus(r.status);

const icon =
  s === "submitted" ? "red"
  : s === "assigned" ? "yellow"
  : "green";
    const m = new google.maps.Marker({
      map,
      position:{ lat:+r.latitude, lng:+r.longitude },
      icon:`http://maps.google.com/mapfiles/ms/icons/${icon}-dot.png`,
      title:r.title
    });

    m.__status = r.status;

    /* â­ é»æ“Š marker â†’ è·³æ¡ˆä»¶è©³æƒ… */
    m.addListener("click",()=>{
      location.href = `report-detail.html?id=${r.id}`;
    });

    return m;
  });
}
function renderTable(reports){
  tableBody.innerHTML = "";

  if (!reports.length) {
    tableBody.innerHTML =
      `<tr><td colspan="5" style="text-align:center;color:#6c757d;">ç„¡ç¬¦åˆæ¡ˆä»¶</td></tr>`;
    return;
  }

  reports.forEach(r=>{
    tableBody.innerHTML += `
      <tr>
        <td>${r.title}</td>
        <td class="${r.severity==="urgent"?"urgent":""}">
          ${r.severity==="urgent"?"ç·Šæ€¥":"ä¸€èˆ¬"}
        </td>
        <td>${statusText(r.status)}</td>
        <td>${r.createdAt?.toDate().toLocaleString("zh-TW") || ""}</td>
        <td>
          <a href="report-detail.html?id=${r.id}">æŸ¥çœ‹</a>
        </td>
      </tr>
    `;
  });
}

/* æ ¸å¿ƒç¯©é¸ */
function applyFilter(status){
  let list =
    status === "all"
      ? allReports
      : allReports.filter(r =>
          normalizeStatus(r.status) === status
        );

  if (status === "submitted") {
    list = sortSubmittedBySeverity(list);
  }

  renderTable(list);

  markers.forEach(m=>{
    m.setVisible(
      status === "all" ||
      normalizeStatus(m.__status) === status
    );
  });
}

function statusText(s){
  s = normalizeStatus(s);
  return s==="submitted" ? "å°šæœªè™•ç†"
       : s==="assigned"  ? "å·²æŒ‡æ´¾"
       : "å·²å®Œæˆ";
}

/* â­ åŒæ­¥ UIï¼ˆå”¯ä¸€å…¥å£ï¼‰ */
function syncUI(status){
  statusFilter.value=status;

  legends.forEach(l=>{
    l.classList.toggle("active",l.dataset.status===status);
  });

  applyFilter(status);
}

/* ä¸‹æ‹‰ */
statusFilter.onchange=()=>{
  syncUI(statusFilter.value);
};

/* åœ–ä¾‹ */
legends.forEach(l=>{
  l.onclick=()=>syncUI(l.dataset.status);
});


</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDWncU5_3lao2CkDNUWf9llEMDywLUBmTs"
  async defer>
</script>

</body>
</html>
